<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smash or Steal ‚Äî Somnia</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #0a0a0a;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: #111;
            border: 2px solid #444;
        }

        #ui {
            position: fixed;
            top: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1000;
        }

        button {
            padding: 10px 16px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: #6c4bff;
            color: white;
            transition: 0.2s;
        }

        button:hover {
            background: #836aff;
        }

        #leaderboard {
            position: fixed;
            right: 10px;
            top: 80px;
            width: 260px;
            height: 340px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 14px;
        }

        h3 { margin-top: 0; }
    </style>
</head>

<body>
    <div id="ui">
        <button id="startBtn">Start</button>
        <button id="connectBtn">Connect Wallet</button>
    </div>

    <canvas id="gameCanvas" width="400" height="600"></canvas>

    <div id="leaderboard">
        <h3>üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥</h3>
        <div id="leaderboardContent">–ü–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫</div>
    </div>

    <!-- Ethers 5 (—Ä–∞–±–æ—Ç–∞—é—â–∞—è –≤–µ—Ä—Å–∏—è) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <script>
        /* ===============================================================
           ===============   –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ==============================
           =============================================================== */

        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        const player = { x: 180, y: 520, width: 40, height: 40, speed: 6 };
        let blocks = [];
        let score = 0;
        let gameRunning = false;

        function resetGame() {
            blocks = [];
            score = 0;
            player.x = 180;
        }

        function spawnBlock() {
            const size = 40;
            const x = Math.random() * (canvas.width - size);
            blocks.push({ x, y: -size, size, speed: 3 + Math.random() * 3 });
        }

        function update() {
            if (!gameRunning) return;

            blocks.forEach(b => b.y += b.speed);

            blocks = blocks.filter(b => {
                const collide =
                    player.x < b.x + b.size &&
                    player.x + player.width > b.x &&
                    player.y < b.y + b.size &&
                    player.y + player.height > b.y;

                if (collide) endGame();
                return b.y < canvas.height;
            });

            if (Math.random() < 0.04) spawnBlock();

            score++;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "cyan";
            ctx.fillRect(player.x, player.y, player.width, player.height);

            ctx.fillStyle = "red";
            blocks.forEach(b => ctx.fillRect(b.x, b.y, b.size, b.size));

            ctx.fillStyle = "white";
            ctx.font = "20px Arial";
            ctx.fillText("Score: " + score, 10, 30);
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        document.addEventListener("keydown", e => {
            if (!gameRunning) return;
            if (e.key === "ArrowLeft" && player.x > 0) player.x -= player.speed;
            if (e.key === "ArrowRight" && player.x < canvas.width - player.width)
                player.x += player.speed;
        });

        function startGame() {
            resetGame();
            gameRunning = true;
        }

        function endGame() {
            gameRunning = false;
            sendScoreToContract(score);
        }

        document.getElementById("startBtn").onclick = startGame;

        loop();

        /* ===============================================================
           ===============   WEB3 –ù–ê–°–¢–†–û–ô–ö–ê ===============================
           =============================================================== */

        const contractAddress = "0x4463449fc972F084428957cE621D5Bc19ffFAD1A";

        const contractABI = [
            "function submitScore(uint256 score) public",
            "function getLeaderboard() public view returns (tuple(address player, uint256 score)[])"
        ];

        let provider, signer, contract;
        let walletConnected = false;

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask / Somnia Wallet –Ω–µ –Ω–∞–π–¥–µ–Ω");
                return;
            }

            try {
                await ethereum.request({ method: "eth_requestAccounts" });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);

                walletConnected = true;
                document.getElementById("connectBtn").innerText = "Wallet Connected ‚úîÔ∏è";

                loadLeaderboard();
            } catch (err) {
                console.error(err);
                alert("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞");
            }
        }

        document.getElementById("connectBtn").onclick = connectWallet;

        /* ===============================================================
           ===============   –û–¢–ü–†–ê–í–ö–ê –°–ö–û–†–ê ===============================
           =============================================================== */

        async function sendScoreToContract(score) {
            if (!walletConnected) {
                alert("–ü–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫ –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–π!");
                return;
            }

            try {
                const tx = await contract.submitScore(score);
                await tx.wait();

                alert("–°—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–ª–æ–∫—á–µ–π–Ω!");
                loadLeaderboard();
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—á—ë—Ç–∞");
            }
        }

        /* ===============================================================
           ===============   –õ–ò–î–ï–†–ë–û–†–î ====================================
           =============================================================== */

        async function loadLeaderboard() {
            if (!walletConnected) return;

            try {
                const data = await contract.getLeaderboard();
                const board = document.getElementById("leaderboardContent");

                board.innerHTML = "";

                data
                    .sort((a, b) => Number(b.score) - Number(a.score))
                    .forEach((entry, i) => {
                        const addr = entry.player;
                        const sc = entry.score;

                        board.innerHTML += `<div>#${i + 1} ‚Äî ${addr.slice(0, 6)}...${addr.slice(-4)} : <b>${sc}</b></div>`;
                    });

            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>
